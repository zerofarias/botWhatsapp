<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>WPPConnect Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        --primary: #1c7ed6;
        --bg: #0f172a;
        --card-bg: rgba(15, 23, 42, 0.85);
        --text: #e2e8f0;
        --muted: #94a3b8;
        --success: #2fb344;
        --error: #e03131;
        --warn: #f08c00;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        margin: 0;
        background: radial-gradient(circle at top left, #1e293b, #020617);
        color: var(--text);
        min-height: 100vh;
      }

      header {
        padding: 1.5rem;
        background: rgba(2, 6, 23, 0.85);
        backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }

      header h1 {
        margin: 0;
        font-weight: 600;
      }

      main {
        padding: 2rem;
        display: grid;
        gap: 1.5rem;
      }

      section {
        background: var(--card-bg);
        border: 1px solid rgba(148, 163, 184, 0.2);
        border-radius: 18px;
        padding: 1.5rem;
        box-shadow: 0 20px 35px -20px rgba(15, 23, 42, 0.6);
      }

      h2 {
        margin-top: 0;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .grid {
        display: grid;
        gap: 1.5rem;
      }

      @media (min-width: 960px) {
        .grid-two {
          grid-template-columns: 1.5fr 1fr;
        }
      }

      .status-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .chip {
        padding: 0.4rem 0.9rem;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.15);
        color: var(--muted);
        font-size: 0.85rem;
      }

      .chip.active {
        background: rgba(31, 179, 68, 0.15);
        color: var(--success);
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }

      button {
        padding: 0.65rem 1.4rem;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-size: 0.95rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease,
          opacity 0.15s ease;
      }

      button.secondary {
        background: rgba(148, 163, 184, 0.3);
      }

      button:disabled {
        opacity: 0.65;
        cursor: not-allowed;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 12px 20px -14px rgba(28, 126, 214, 0.9);
      }

      form {
        display: grid;
        gap: 1rem;
      }

      label {
        display: grid;
        gap: 0.4rem;
        font-size: 0.9rem;
        color: var(--muted);
      }

      input,
      textarea {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        font-size: 0.95rem;
        resize: vertical;
      }

      pre {
        background: rgba(15, 23, 42, 0.65);
        border-radius: 14px;
        padding: 1rem;
        font-size: 0.75rem;
        line-height: 0.9rem;
        overflow: auto;
        max-height: 360px;
        border: 1px solid rgba(148, 163, 184, 0.16);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      th,
      td {
        padding: 0.6rem 0.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.12);
        text-align: left;
      }

      tbody tr:hover {
        background: rgba(148, 163, 184, 0.08);
      }

      .log {
        display: grid;
        gap: 0.5rem;
        font-family: 'Fira Mono', 'Courier New', Courier, monospace;
        font-size: 0.85rem;
      }

      .log-entry {
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        background: rgba(148, 163, 184, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.12);
      }

      .log-entry.info {
        border-color: rgba(47, 179, 68, 0.3);
      }

      .log-entry.warn {
        border-color: rgba(240, 140, 0, 0.3);
      }

      .log-entry.error {
        border-color: rgba(224, 49, 49, 0.3);
      }

      .qr-placeholder {
        color: var(--muted);
      }

      .message {
        color: var(--muted);
        min-height: 1rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>WPPConnect Dashboard</h1>
      <p id="session-name">Session: &mdash;</p>
    </header>
    <main class="grid grid-two">
      <section>
        <h2>Controls</h2>
        <div class="controls">
          <button id="start-btn">Start Session</button>
          <button id="stop-btn" class="secondary">Stop Session</button>
          <span id="connection-state" class="chip">IDLE</span>
        </div>
        <p class="message" id="action-feedback"></p>
        <div>
          <h3>Status History</h3>
          <div class="status-chips" id="status-history"></div>
        </div>
      </section>

      <section>
        <h2>QR Code</h2>
        <pre id="qr-display" class="qr-placeholder">
Waiting for QR code...
        </pre>
      </section>

      <section>
        <h2>Send a Message</h2>
        <form id="send-message-form">
          <label>
            Recipient (e.g. 5511999999999@c.us)
            <input type="text" name="to" placeholder="Recipient JID" required />
          </label>
          <label>
            Message
            <textarea
              name="message"
              rows="4"
              placeholder="Type the message you want to send"
              required
            ></textarea>
          </label>
          <div class="controls">
            <button type="submit">Send Message</button>
            <span id="send-feedback" class="message"></span>
          </div>
        </form>
      </section>

      <section>
        <h2>Recent Messages</h2>
        <div style="overflow-x: auto">
          <table>
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>From</th>
                <th>Preview</th>
              </tr>
            </thead>
            <tbody id="message-history">
              <tr>
                <td colspan="3">Waiting for data...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section>
        <h2>Logs</h2>
        <div id="log-output" class="log"></div>
      </section>
    </main>

    <script>
      const $ = (selector) => document.querySelector(selector);
      const statusEndpoint = '/api/status';

      const elements = {
        sessionName: $('#session-name'),
        connectionState: $('#connection-state'),
        statusHistory: $('#status-history'),
        qrDisplay: $('#qr-display'),
        messageHistory: $('#message-history'),
        logOutput: $('#log-output'),
        startBtn: $('#start-btn'),
        stopBtn: $('#stop-btn'),
        actionFeedback: $('#action-feedback'),
        sendForm: $('#send-message-form'),
        sendFeedback: $('#send-feedback'),
      };

      async function fetchStatus() {
        try {
          const response = await fetch(statusEndpoint, {
            cache: 'no-store',
          });
          if (!response.ok) {
            throw new Error(`Request failed: ${response.status}`);
          }

          const data = await response.json();
          updateDashboard(data);
        } catch (error) {
          console.error(error);
          elements.actionFeedback.textContent =
            'Cannot reach dashboard API. Check the backend.';
        }
      }

      function updateDashboard(data) {
        elements.sessionName.textContent = `Session: ${data.session}`;
        elements.connectionState.textContent =
          data.connectionState || (data.running ? 'RUNNING' : 'IDLE');
        elements.connectionState.classList.toggle(
          'active',
          Boolean(data.running)
        );

        if (data.qr && data.qr.ascii) {
          elements.qrDisplay.textContent = data.qr.ascii;
          elements.qrDisplay.classList.remove('qr-placeholder');
        } else {
          elements.qrDisplay.textContent = 'Waiting for QR code...';
          elements.qrDisplay.classList.add('qr-placeholder');
        }

        renderStatusHistory(data.statusHistory || []);
        renderMessageHistory(data.messageHistory || []);
        renderLogs(data.logs || []);

        elements.startBtn.disabled = data.isStarting || data.running;
        elements.stopBtn.disabled = data.isStopping || !data.running;
      }

      function renderStatusHistory(statusHistory) {
        elements.statusHistory.innerHTML = '';

        if (!statusHistory.length) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = 'No status yet';
          elements.statusHistory.appendChild(chip);
          return;
        }

        statusHistory
          .slice()
          .reverse()
          .forEach((entry) => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = `${entry.status} • ${formatTime(
              entry.timestamp
            )}`;
            elements.statusHistory.appendChild(chip);
          });
      }

      function renderMessageHistory(messages) {
        if (!messages.length) {
          elements.messageHistory.innerHTML =
            '<tr><td colspan="3">No messages yet.</td></tr>';
          return;
        }

        const rows = messages
          .slice()
          .reverse()
          .map(
            (message) => `
              <tr>
                <td>${formatTime(message.timestamp)}</td>
                <td>${escapeHtml(message.from)}</td>
                <td>${escapeHtml(message.body || '<no content>')}</td>
              </tr>
            `
          )
          .join('');

        elements.messageHistory.innerHTML = rows;
      }

      function renderLogs(logs) {
        if (!logs.length) {
          elements.logOutput.innerHTML =
            '<div class="log-entry">No logs yet.</div>';
          return;
        }

        elements.logOutput.innerHTML = logs
          .slice()
          .reverse()
          .map(
            (log) => `
              <div class="log-entry ${log.level}">
                <strong>[${log.level.toUpperCase()}]</strong>
                ${formatTime(log.timestamp)} — ${escapeHtml(log.message)}
              </div>
            `
          )
          .join('');
      }

      function formatTime(value) {
        if (!value) return '';
        try {
          return new Intl.DateTimeFormat(undefined, {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
          }).format(new Date(value));
        } catch (error) {
          return value;
        }
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      async function callAction(endpoint, feedbackEl) {
        feedbackEl.textContent = '';
        try {
          const response = await fetch(endpoint, { method: 'POST' });
          const payload = await response.json().catch(() => ({}));

          if (!response.ok || payload.ok === false) {
            const message = payload.error || 'Action failed.';
            feedbackEl.textContent = message;
            fetchStatus();
            return;
          }

          feedbackEl.textContent = 'Action completed.';
        } catch (error) {
          feedbackEl.textContent = 'Request failed. See console for details.';
          console.error(error);
        } finally {
          fetchStatus();
        }
      }

      elements.startBtn.addEventListener('click', () => {
        callAction('/api/start', elements.actionFeedback);
      });

      elements.stopBtn.addEventListener('click', () => {
        callAction('/api/stop', elements.actionFeedback);
      });

      elements.sendForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(elements.sendForm);
        const payload = {
          to: String(formData.get('to') || '').trim(),
          message: String(formData.get('message') || '').trim(),
        };

        if (!payload.to || !payload.message) {
          elements.sendFeedback.textContent = 'Please fill all fields.';
          return;
        }

        elements.sendFeedback.textContent = 'Sending...';

        try {
          const response = await fetch('/api/send-message', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
          });

          const data = await response.json().catch(() => ({}));

          if (!response.ok || data.ok === false) {
            const message = data.error || 'Failed to send message.';
            elements.sendFeedback.textContent = message;
            fetchStatus();
            return;
          }

          elements.sendFeedback.textContent = 'Message sent.';
          elements.sendForm.reset();
          fetchStatus();
        } catch (error) {
          console.error(error);
          elements.sendFeedback.textContent =
            'Request failed. Check the console.';
        }
      });

      fetchStatus();
      setInterval(fetchStatus, 4000);
    </script>
  </body>
</html>
