generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Node {
  id             Int      @id @default(autoincrement())
  flowId         Int      @map("flow_id")
  name           String
  type           NodeType @default(TEXT)
  content        String?
  orderIndex     Int      @default(0) @map("order_index")
  metadata       String?  @db.LongText
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  condition      String?
  trueNodeId     Int?
  falseNodeId    Int?
  seconds        Int?
  targetBotId    Int?
  agentId        Int?
  prompt         String?
  model          String?
  expectedType   String?
  variable       String?
  value          String?  @db.LongText
  welcomeMessage String?
  flow           Flow     @relation(fields: [flowId], references: [id])

  @@index([flowId], map: "nodes_flow_id_fkey")
  @@map("nodes")
}

model Area {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  description   String?
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  contacts      Contact[]
  conversations Conversation[]
  flows         Flow[]
  quickReplies  QuickReply[]
  userAreas     UserArea[]
  defaultUsers  User[]         @relation("AreaDefaultUsers")
  workingHours  WorkingHour[]

  @@map("areas")
}

model User {
  id                 Int                 @id @default(autoincrement())
  name               String
  username           String              @unique
  email              String?             @unique
  passwordHash       String              @map("password_hash")
  role               UserRole            @default(OPERATOR)
  defaultAreaId      Int?                @map("default_area_id")
  isActive           Boolean             @default(true) @map("is_active")
  lastLoginAt        DateTime?           @map("last_login_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  botSessions        BotSession[]
  conversationEvents ConversationEvent[]
  assignedChats      Conversation[]      @relation("ConversationAssignedTo")
  closedChats        Conversation[]      @relation("ConversationClosedBy")
  flows              Flow[]              @relation("FlowCreator")
  messages           Message[]
  quickReplies       QuickReply[]
  areas              UserArea[]
  defaultArea        Area?               @relation("AreaDefaultUsers", fields: [defaultAreaId], references: [id])
  settingsAudits     SettingsAudit[]

  @@index([defaultAreaId], map: "users_default_area_id_fkey")
  @@map("users")
}

model UserArea {
  userId     Int      @map("user_id")
  areaId     Int      @map("area_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  area       Area     @relation(fields: [areaId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@id([userId, areaId])
  @@index([areaId], map: "user_areas_area_id_fkey")
  @@map("user_areas")
}

model Bot {
  id            Int      @id @default(autoincrement())
  name          String
  description   String?
  isDefault     Boolean  @default(false) @map("is_default")
  initialFlowId Int?     @map("initial_flow_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  flows         Flow[]

  @@index([isDefault], map: "idx_bots_is_default")
  @@map("bots")
}

model BotSession {
  id          Int              @id @default(autoincrement())
  ownerUserId Int              @map("owner_user_id")
  status      BotSessionStatus @default(DISCONNECTED)
  sessionName String           @default("default") @map("session_name")
  connectedAt DateTime?        @map("connected_at")
  lastQr      String?          @map("last_qr")
  headless    Boolean          @default(true)
  paused      Boolean          @default(false)
  autoStart   Boolean          @default(false) @map("auto_start")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  owner       User             @relation(fields: [ownerUserId], references: [id])

  @@unique([ownerUserId, sessionName], map: "ux_bot_sessions_owner")
  @@map("bot_sessions")
}

model Flow {
  id                  Int              @id @default(autoincrement())
  name                String
  trigger             String?
  message             String           @db.LongText
  type                String?          @db.VarChar(32)
  parentId            Int?             @map("parent_id")
  areaId              Int?             @map("area_id")
  orderIndex          Int              @default(0) @map("order_index")
  metadata            String?          @db.LongText
  isActive            Boolean          @default(true) @map("is_active")
  createdBy           Int              @map("created_by")
  createdAt           DateTime         @default(now()) @map("created_at")
  updatedAt           DateTime         @updatedAt @map("updated_at")
  botId               Int              @map("bot_id")
  outgoingConnections FlowConnection[] @relation("FromFlow")
  incomingConnections FlowConnection[] @relation("ToFlow")
  area                Area?            @relation(fields: [areaId], references: [id])
  bot                 Bot              @relation(fields: [botId], references: [id], onUpdate: Restrict)
  creator             User             @relation("FlowCreator", fields: [createdBy], references: [id])
  parent              Flow?            @relation("FlowHierarchy", fields: [parentId], references: [id])
  children            Flow[]           @relation("FlowHierarchy")
  nodes               Node[]

  @@index([parentId], map: "idx_flows_parent")
  @@index([areaId], map: "idx_flows_area")
  @@index([trigger], map: "idx_flows_trigger")
  @@index([botId], map: "idx_flows_bot")
  @@index([createdBy], map: "flows_created_by_fkey")
  @@map("flows")
}

model FlowConnection {
  id      Int    @id @default(autoincrement())
  fromId  Int    @map("from_id")
  toId    Int    @map("to_id")
  trigger String
  from    Flow   @relation("FromFlow", fields: [fromId], references: [id])
  to      Flow   @relation("ToFlow", fields: [toId], references: [id])

  @@unique([fromId, toId], map: "ux_flow_connections_pair")
  @@index([toId], map: "flow_connections_to_id_fkey")
  @@map("flow_connections")
}

model Conversation {
  id                BigInt                       @id @default(autoincrement())
  userPhone         String                       @map("user_phone")
  contactName       String?                      @map("contact_name")
  contactId         Int?                         @map("contact_id")
  areaId            Int?                         @map("area_id")
  assignedToId      Int?                         @map("assigned_to")
  status            ConversationStatus           @default(PENDING)
  progressStatus    ConversationProgressStatus   @default(PENDING) @map("progress_status")
  botActive         Boolean                      @default(true) @map("bot_active")
  lastActivity      DateTime                     @default(now()) @map("last_activity")
  lastBotMessageAt  DateTime?                    @map("last_bot_message_at")
  closedAt          DateTime?                    @map("closed_at")
  closedReason      String?                      @map("closed_reason")
  closedById        Int?                         @map("closed_by")
  createdAt         DateTime                     @default(now()) @map("created_at")
  updatedAt         DateTime                     @updatedAt @map("updated_at")
  currentFlowNodeId Int?                         @map("current_flow_node_id")
  context           String?                      @map("context") @db.LongText
  botId             Int?                         @map("bot_id")
  events            ConversationEvent[]
  orders            Order[]
  area              Area?                        @relation(fields: [areaId], references: [id])
  assignedTo        User?                        @relation("ConversationAssignedTo", fields: [assignedToId], references: [id])
  closedBy          User?                        @relation("ConversationClosedBy", fields: [closedById], references: [id])
  contact           Contact?                     @relation(fields: [contactId], references: [id])
  messages          Message[]

  @@index([userPhone], map: "idx_conversations_user_phone")
  @@index([status], map: "idx_conversations_status")
  @@index([areaId], map: "idx_conversations_area")
  @@index([assignedToId], map: "idx_conversations_assigned_to")
  @@index([lastActivity], map: "idx_conversations_last_activity")
  @@index([contactId], map: "idx_conversations_contact")
  @@index([botId], map: "idx_conversations_bot")
  @@index([closedById], map: "conversations_closed_by_fkey")
  @@map("conversations")
}

model Message {
  id             BigInt        @id @default(autoincrement())
  conversationId BigInt        @map("conversation_id")
  senderType     MessageSender @map("sender_type")
  senderId       Int?          @map("sender_id")
  content        String
  mediaType      String?       @map("media_type")
  mediaUrl       String?       @map("media_url")
  isDelivered    Boolean       @default(true) @map("is_delivered")
  isRead         Boolean       @default(false) @map("is_read")
  externalId     String?       @unique @map("external_id")
  createdAt      DateTime      @default(now()) @map("created_at")
  conversation   Conversation  @relation(fields: [conversationId], references: [id])
  sender         User?         @relation(fields: [senderId], references: [id])

  @@index([conversationId], map: "idx_messages_conversation")
  @@index([senderType, senderId], map: "idx_messages_sender")
  @@index([senderId], map: "messages_sender_id_fkey")
  @@map("messages")
}

model ConversationEvent {
  id             BigInt                @id @default(autoincrement())
  conversationId BigInt                @map("conversation_id")
  eventType      ConversationEventType @map("event_type")
  payload        String?               @map("payload") @db.LongText
  createdById    Int?                  @map("created_by")
  createdAt      DateTime              @default(now()) @map("created_at")
  conversation   Conversation          @relation(fields: [conversationId], references: [id])
  createdBy      User?                 @relation(fields: [createdById], references: [id])

  @@index([conversationId], map: "idx_conversation_events_conversation")
  @@index([createdById], map: "conversation_events_created_by_fkey")
  @@map("conversation_events")
}

model Session {
  sid     String    @id @map("sid")
  expires DateTime?
  data    String?   @db.Text

  @@map("sessions")
}

model Contact {
  id            Int            @id @default(autoincrement())
  name          String
  phone         String         @unique
  dni           String?        @db.VarChar(20)
  obraSocial    String?        @map("obra_social") @db.VarChar(255)
  obraSocial2   String?        @map("obra_social2") @db.VarChar(255)
  address1      String?        @map("address1") @db.VarChar(255)
  address2      String?        @map("address2") @db.VarChar(255)
  areaId        Int?           @map("area_id")
  isVip         Boolean        @default(false) @map("is_vip")
  isProblematic Boolean        @default(false) @map("is_problematic")
  isChronic     Boolean        @default(false) @map("is_chronic")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  photoUrl      String?        @map("photo_url") @db.LongText
  area          Area?          @relation(fields: [areaId], references: [id])
  conversations Conversation[]
  reminders     ContactReminder[]

  @@index([areaId], map: "contacts_area_id_fkey")
  @@map("contacts")
}

model ContactReminder {
  id                 Int       @id @default(autoincrement())
  contactId          Int       @map("contact_id")
  title              String
  description        String?   @db.Text
  remindAt           DateTime  @map("remind_at")
  repeatIntervalDays Int?      @map("repeat_interval_days")
  repeatUntil        DateTime? @map("repeat_until")
  lastTriggeredAt    DateTime? @map("last_triggered_at")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  contact            Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([contactId], map: "contact_reminders_contact_id_idx")
  @@index([remindAt], map: "contact_reminders_remind_at_idx")
  @@map("contact_reminders")
}

model WorkingHour {
  id        Int      @id @default(autoincrement())
  areaId    Int      @map("area_id")
  startTime String   @map("start_time")
  endTime   String   @map("end_time")
  days      String
  message   String?  @map("message")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  area      Area     @relation(fields: [areaId], references: [id])

  @@index([areaId], map: "working_hours_area_id_fkey")
  @@map("working_hours")
}

model QuickReply {
  id        Int      @id @default(autoincrement())
  title     String
  content   String   @db.Text
  shortcut  String?  @unique
  areaId    Int?     @map("area_id")
  userId    Int?     @map("user_id")
  isGlobal  Boolean  @default(false) @map("is_global")
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  area      Area?    @relation(fields: [areaId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([areaId])
  @@index([userId])
  @@map("quick_replies")
}

model SystemSettings {
  id                 Int      @id @default(1)
  timezone           String   @default("America/Buenos_Aires")
  language           String   @default("es")
  dateFormat         String   @default("DD/MM/YYYY") @map("date_format")
  autoCloseMinutes   Int      @default(30) @map("auto_close_minutes")
  notificationsEmail Boolean  @default(true) @map("notifications_email")
  notificationsWeb   Boolean  @default(true) @map("notifications_web")
  notificationsPush  Boolean  @default(false) @map("notifications_push")
  quietHours         Json?    @map("quiet_hours")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model SettingsAudit {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  action      String
  description String?
  changes     Json?    @map("changes")
  createdAt   DateTime @default(now()) @map("created_at")
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], map: "settings_audit_user_id_fkey")
  @@map("settings_audit")
}

model Order {
  id                  Int             @id @default(autoincrement())
  conversationId      BigInt          @map("conversation_id")
  conversation        Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  clientPhone         String          @map("client_phone")
  clientName          String?         @map("client_name")
  tipoConversacion    String          @map("tipo_conversacion")
  itemsJson           String          @map("items_json") @db.LongText
  concept             String?         @map("concept")
  requestDetails      String?         @map("request_details") @db.Text
  customerData        String?         @map("customer_data") @db.Text
  paymentMethod       String?         @map("payment_method")
  confirmationMessage String?         @map("confirmation_message") @db.Text
  confirmationSentAt  DateTime?       @map("confirmation_sent_at")
  notas               String?         @map("notas") @db.Text
  especificaciones    String?         @map("especificaciones") @db.Text
  status              OrderStatus     @default(PENDING) @map("status")
  closeReason         String?         @map("close_reason")
  createdAt           DateTime        @default(now()) @map("created_at")
  closedAt            DateTime?       @map("closed_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  @@index([conversationId], map: "idx_orders_conversation_id")
  @@index([status], map: "idx_orders_status")
  @@index([clientPhone], map: "idx_orders_client_phone")
  @@index([createdAt], map: "idx_orders_created_at")
  @@map("orders")
}

model FlowData {
  id              Int         @id @default(autoincrement())
  botId           Int         @map("bot_id")
  conversationId  BigInt      @map("conversation_id")
  dataType        String      @map("data_type")
  variables       String      @map("variables") @db.LongText
  phoneNumber     String?     @map("phone_number")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([botId], map: "idx_flow_data_bot")
  @@index([dataType], map: "idx_flow_data_type")
  @@index([conversationId], map: "idx_flow_data_conversation")
  @@index([createdAt], map: "idx_flow_data_created_at")
  @@map("flow_data")
}

enum UserRole {
  ADMIN      @map("admin")
  SUPERVISOR @map("supervisor")
  OPERATOR   @map("operator")
  SUPPORT    @map("support")
  SALES      @map("sales")
}

enum BotSessionStatus {
  CONNECTED    @map("connected")
  CONNECTING   @map("connecting")
  DISCONNECTED @map("disconnected")
  ERROR        @map("error")
}

enum ConversationStatus {
  PENDING @map("pending")
  ACTIVE  @map("active")
  PAUSED  @map("paused")
  CLOSED  @map("closed")
}

enum ConversationProgressStatus {
  PENDING        @map("pending")
  IN_PREPARATION @map("in_preparation")
  COMPLETED      @map("completed")
  CANCELLED      @map("cancelled")
  INACTIVE       @map("inactive")
}

enum OrderStatus {
  PENDING     @map("pending")
  CONFIRMADO  @map("confirmado")
  COMPLETADO  @map("completado")
  CANCELADO   @map("cancelado")
}

enum MessageSender {
  CONTACT  @map("contact")
  BOT      @map("bot")
  OPERATOR @map("operator")
}

enum ConversationEventType {
  ASSIGNMENT    @map("assignment")
  STATUS_CHANGE @map("status_change")
  BOT_TOGGLE    @map("bot_toggle")
  NOTE          @map("note")
}

enum NodeType {
  START
  TEXT
  CONDITIONAL
  DELAY
  REDIRECT_BOT
  REDIRECT_AGENT
  AI
  SET_VARIABLE
  HTTP
  END
  END_CLOSED
  ORDER
  SCHEDULE
  DATA_LOG
}
